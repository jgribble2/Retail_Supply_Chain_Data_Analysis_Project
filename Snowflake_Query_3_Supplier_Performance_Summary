WITH ONTIME AS (
  SELECT 
    PO.SUPPLIER_ID,
    AVG(CASE WHEN ARRIVAL_DATE <= EXPECTED_DELIVERY THEN 1 ELSE 0 END) AS ON_TIME_RATE
  FROM
    "RETAIL_SUPPLY_CHAIN_DATA_PROJECT"."PUBLIC"."PURCHASE_ORDERS" AS PO
  JOIN
    "RETAIL_SUPPLY_CHAIN_DATA_PROJECT"."PUBLIC"."SHIPMENTS" AS SH
    ON PO.PO_ID = SH.PO_ID
  GROUP BY
    PO.SUPPLIER_ID
)
SELECT
  SU.*,
  ROUND(O.ON_TIME_RATE*100,2) AS ON_TIME_PERCENTAGE
FROM
    "RETAIL_SUPPLY_CHAIN_DATA_PROJECT"."PUBLIC"."SUPPLIERS" AS SU
LEFT JOIN 
    ONTIME O 
    ON SU.SUPPLIER_ID = O.SUPPLIER_ID;
